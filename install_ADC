#!/bin/bash

########################################################################
#                              install_ADC
#-----------------------------------------------------------------------
#               A simple script to install the ADC program
########################################################################

#-----------------------------------------------------------------------
# Read target name. If target is not given, then perform a clean install
#-----------------------------------------------------------------------
target=$1

#-----------------------------------------------------------------------
# $args: list of variables to be passed to make
#-----------------------------------------------------------------------
args=""

#-----------------------------------------------------------------------
# Get variables from ADC.CONFIG if it exists
#-----------------------------------------------------------------------
if [ -f "ADC.CONFIG" ]; then
    blasflag=`cat ADC.CONFIG | grep LIB_BLAS | sed 's/.*=//g'`
    lapackflag=`cat ADC.CONFIG | grep LIB_LAPACK | sed 's/.*=//g'`
    slepcpath=`cat ADC.CONFIG | grep SLEPC_DIR | sed 's/.*=//g'`
fi

#
# MKL, sequential
#
#blasflag='-mkl=sequential'
#lapackflag='-mkl=sequential'

#
# MKL, parallel
#
#blasflag='-mkl'
#lapackflag='-mkl'

#
# BLAS/LAPACK
#
#blasflag='-lblas'
#lapackflag='-llapack'

#-----------------------------------------------------------------------
# Determine whether to install using the PETSc/SLEPc libraries
#-----------------------------------------------------------------------
read -p "Do you wish to install using the PETSc/SLEPc libraries (y/n) " ext

valid=0
while [ "$valid" == '0' ]; do
    if [ "$ext" == 'y' ]; then
	valid=1
	args+=" "EXTDIAG=true
    elif [ "$ext" == 'n' ]; then
	valid=1
	args+=" "EXTDIAG=false
    else
	read -p "Invalid answer: y or n only: " ext
    fi
done

#-----------------------------------------------------------------------
# Determine the path to the SLEPc install directory
#-----------------------------------------------------------------------
if [ -z $slepcpath ]; then

    if [ -z $SLEPC_DIR ]; then
	found=false
    else
	if [ -d $SLEPC_DIR ]; then
	    found=true
	else
	    found=false
	fi
    fi

    if [ "$found" == 'false' ]; then
	if [ -d $HOME/slepc*/conf/ ]; then
	    slepcpath=`ls -d $HOME/slepc*/conf/ | sed 's/conf\///g'`
	else
	    read -p "Please enter the path to the SLEPc install directory:  " slepcpath	
	fi
    else
	slepcpath=$SLEPC_DIR
    fi

fi

args+=" "SLEPC_DIR=$slepcpath

#-----------------------------------------------------------------------
# Determine BLAS and LAPACK compiler flags
#-----------------------------------------------------------------------
if [ -z $blasflag ]; then
    echo ""
    read -p "Please enter the BLAS linking flag:  " blasflag
fi

if [ -z $lapackflag ]; then
    read -p "Please enter the LAPACK linking flag:  " lapackflag
fi

args+=" "LIB_BLAS=$blasflag
args+=" "LIB_LAPACK=$lapackflag

#-----------------------------------------------------------------------
# Write variables to ADC.CONFIG for future use
#-----------------------------------------------------------------------
if [ -f "ADC.CONFIG" ]; then
    rm ADC.CONFIG
fi

echo "LIB_BLAS=$blasflag" >>ADC.CONFIG
echo "LIB_LAPACK=$lapackflag" >>ADC.CONFIG
echo "SLEPC_PATH=$slepcpath" >>ADC.CONFIG

#-----------------------------------------------------------------------
# Calls to make
#-----------------------------------------------------------------------
list=(clean_all adc stieltjes_ap mcspline knit)

if [ -z $target ]; then
    for T in "${list[@]}"; do
	make $T $args
    done
else
    make $target $args
fi

#-----------------------------------------------------------------------
# Compile the documentation
#-----------------------------------------------------------------------
echo
echo "Compiling the documentation..."

cd doc
pdflatex input >/dev/null
rm *.aux *.log
cd ..

#-----------------------------------------------------------------------
# Set the ADC_DIR variable
#-----------------------------------------------------------------------
star40='****************************************'
star20='********************'

file=$HOME/.bashrc

sed -e '/^\#\*ADC\*A\*/,/^\#\*ADC\*B\*/d' $file > tmpf$$
sed -e '/^\#\*ADC\*A\*/,/^\#\*ADC\*B\*/d' tmpf$$ >| $file
/bin/rm  tmpf$$

echo "#*ADC*A***********$star40$star20" >> $file
echo '# Following lines written by install_ADC.  '"$(date)" >> $file
echo 'export ADC_DIR='`pwd` >> $file
echo "#*ADC*B***********$star40$star20" >> $file

echo
echo "ADC_DIR written to $file"
echo ""
echo

#exec bash

